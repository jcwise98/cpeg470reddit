<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="index.css">
  <title>Reddit</title>

  <!-- update the version number as needed
  <script defer src="/__/firebase/7.2.2/firebase-app.js"></script>
  <!-- include only the Firebase features as you need
  <script defer src="/__/firebase/7.2.2/firebase-auth.js"></script>
  <script defer src="/__/firebase/7.2.2/firebase-database.js"></script>
  <script defer src="/__/firebase/7.2.2/firebase-messaging.js"></script>
  <script defer src="/__/firebase/7.2.2/firebase-storage.js"></script>
  <!-- initialize the SDK after all desired features are loaded
  <script defer src="/__/firebase/init.js"></script>-->

  <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
</head>

<body style="background-color:#F2F1F2">


  <nav class="navbar navbar-light" style="background-color:#1F0425">

    <div class="container-fluid">

      <div class="navbar-header">

        <a class="navbar-brand" <title>Reddit</title>
        </a>

        <img src="https://i2.wp.com/pivx.org/wp-content/uploads/2017/01/reddit.png?w=1080&ssl=1" alt="logo"
          class="logo">

      </div>
      <ul class="nav navbar-nav">
        <li class="active"><a href="https://cpeg470-reddit.firebaseapp.com/">Home</a></li>
      </ul>

      <form class="navbar-form navbar-left" action="/action_page.php">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search Reddit" name="search">
        </div>
        <button type="submit" class="btn btn-default"> <img src="https://img.icons8.com/pastel-glyph/2x/search--v2.png"
            alt="logo" class="logoo"></button>
      </form>
      <div class="nav navbar-nav">
        <span id="welcomeMsg" style="color: white;"></span>
      </div>
      <ul class="nav navbar-nav navbar-right">

        <button class="btn btn-default" onclick="document.getElementById('id01').style.display='block'">Login <img
            src="https://www.pinclipart.com/picdir/middle/200-2008697_account-customer-login-man-user-icon-login-icon.png"
            alt="logo" class="logoo"></button>
        <!-- The Modal -->
        <div id="id01" class="modal">
          <span onclick="document.getElementById('id01').style.display='none'" class="close"
            title="Close Modal">&times;</span>

          <!-- Modal Content -->
          <div class="login">
            <form class="modal-content animate">
              <div class="imgcontainer">
              </div>

              <div class="container">
                <label for="email"><b><img
                      src="https://icon-library.net/images/anonymous-avatar-icon/anonymous-avatar-icon-7.jpg"
                      alt="Avatar" class="logo"> Email</b></label>
                <input class="email" type="email" placeholder="Enter Email" name="email" required>

                <label for="psw"><b>Password</b></label>
                <input class="password" type="password" placeholder="Enter Password" name="psw" required>

                <button type="submit" onclick="document.getElementById('id01').style.display='none'">Login</button>
              </div>
              <div class="container" style="background-color:#f1f1f1">
                <button type="button" onclick="document.getElementById('id01').style.display='none'"
                  class="cancelbtn">Cancel</button>
              </div>
            </form>
          </div>
        </div>

        <button id="logoutBtn" class="btn btn-default" type="button"
          onclick="document.getElementById('modal-logout').style.display='block'">Logout <img
            src="https://icon-library.net/images/log-out-icon/log-out-icon-10.jpg" alt="logo" class="logoo"></button>
      </ul>
      <ul class="nav navbar-nav navbar-right">

        <button class="btn btn-default" onclick="document.getElementById('id02').style.display='block'">Register <img
            src="http://cdn.onlinewebfonts.com/svg/img_355097.png" alt="logo" class="logoo"></button>
        <!-- The Modal -->
        <div id="id02" class="modal">
          <span onclick="document.getElementById('id02').style.display='none'" class="close"
            title="Close Modal">&times;</span>

          <!-- Modal Content -->
          <div class="register">
            <form class="modal-content animate">
              <div class="imgcontainer">
              </div>
              <div class="container">
                <label for="emailReg"><b><img
                      src="https://icon-library.net/images/anonymous-avatar-icon/anonymous-avatar-icon-5.jpg"
                      alt="Avatar" class="logo"> Sign Up</b></label>
                <input class="email" type="email" placeholder="Register Email" name="emailReg" required>

                <label for="pswReg"><b>Password</b></label>
                <input class="password" type="password" placeholder="Enter Password" name="pswReg" required>

                <button type="submit" onclick="document.getElementById('id02').style.display='none'">Register</button>
              </div>

              <div class="container" style="background-color:#f1f1f1">
                <button type="button" onclick="document.getElementById('id02').style.display='none'"
                  class="cancelbtn">Cancel</button>
              </div>
            </form>
          </div>
        </div>

      </ul>
    </div>

  </nav>



  <div class="form-group">
    <input id="createpost" type="text" class="form-control" placeholder="Create Post" name="search">
  </div>

  <button id="postbutton" class="postbtn btn-default" type="button">Post
    <img src="https://icon-library.net/images/write-post-icon/write-post-icon-19.jpg" alt="logo" class="logoo"></button>

  <button id="attachbtn" class="attachButton" type="button">
    <img src="https://icon-library.net/images/attach-icon-png/attach-icon-png-17.jpg" class="attachimg"> Attach
    Image</button>




  <div class="container">

    <div class="column">
      <div id="post_row" class="row">
        <!--<div class="card">
          <span id="post"></span>
          <br>
          <span class="likebtn-wrapper" data-theme="custom" data-icon_l="thmb8-u" data-icon_d="thmb8-d"
            data-icon_l_c_v="#528d41" data-icon_d_c_v="#fb0505" data-white_label="true" data-rich_snippet="true"
            data-identifier="item_1" data-show_like_label="false" data-share_enabled="false"
            data-share_size="small"></span>
          <script>(function (d, e, s) { if (d.getElementById("likebtn_wjs")) return; a = d.createElement(e); m = d.getElementsByTagName(e)[0]; a.async = 1; a.id = "likebtn_wjs"; a.src = s; m.parentNode.insertBefore(a, m) })(document, "script", "//w.likebtn.com/js/w/widget.js");</script>
        </div> -->
      </div>
    </div>
  </div>
</body>
<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyBBj93-0ZUhkz31nT8u-lGD9982zP0Tf1Y",
    authDomain: "cpeg470-reddit.firebaseapp.com",
    databaseURL: "https://cpeg470-reddit.firebaseio.com",
    projectId: "cpeg470-reddit",
    storageBucket: "cpeg470-reddit.appspot.com",
    messagingSenderId: "530492936109",
    appId: "1:530492936109:web:cfeb7b01d2240ae48c1b24"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  let displayPost = function (val, likeNum, id, date) {
    var likeBtn = document.getElementById('button' + id);
    likeBtn.innerHTML = likeNum;
  }

  let createPost = function (val, emailAddr) {
    var rootRef = firebase.database().ref();
    var nextPost;
    rootRef.child("numPosts").once("value", function (snapshot) {
      var data = snapshot.val();
      data++;
      nextPost = data;
      firebase.database().ref("numPosts").set(nextPost);

      var postsRef = rootRef.child('posts/' + nextPost);
      //var newPostRef = postsRef.push();
      var today = new Date();
      var dd = today.getDate();
      var mm = today.getMonth() + 1; //January is 0!

      var yyyy = today.getFullYear();
      var h = today.getHours();
      var m = today.getMinutes();
      m = checkTime(m);
      function checkTime(i) {
        if (i < 10) { i = "0" + i };  // add zero in front of numbers < 10
        return i;
      }
      if (dd < 10) {
        dd = '0' + dd;
      }
      if (mm < 10) {
        mm = '0' + mm;
      }
      var today = mm + '/' + dd + '/' + yyyy + " " + h + ":" + m;
      postsRef.update({
        text: val,
        likes: 0,
        id: nextPost,
        date: today,
        email: emailAddr
      });
      //readPost(val);
      alert("Post has been added!");
      location.reload();
    });
  }

  let readPost = function (val, likeNum, id, today, email) {
    var parentElement = document.getElementById('post_row');
    var br = document.createElement('br');
    var div = document.createElement('div');
    var div2 = document.createElement('div');
    var div3 = document.createElement('div');
    var divDate = document.createElement('div');
    var span = document.createElement('span');
    var spanDate = document.createElement('span');
    var spanUser = document.createElement('span');
    var likebtn = document.createElement('button');
    var dislikebtn = document.createElement('button');
    var deletebtn = document.createElement('button');
    var comment = document.createElement('input');
    var cmntbtn = document.createElement('button');
    span.innerHTML = val;

    spanDate.innerHTML = today;
    spanUser.innerHTML = "Posted by: " + email;
    likebtn.innerHTML = likeNum;
    likebtn.setAttribute('style', 'background-color:#EFF9F8');
    likebtn.setAttribute('class', 'likeButton');
    dislikebtn.setAttribute('style', 'background-color:#FEDDDD');
    dislikebtn.setAttribute('class', 'dislikeButton');
    deletebtn.setAttribute('style', 'background-color: #ECEBEB');
    deletebtn.setAttribute('class', 'deleteButton');
    comment.setAttribute('class', 'commentSection');
    comment.setAttribute('type', 'text');
    comment.setAttribute('placeholder', 'Comment Here...');
    deletebtn.innerHTML = "Delete Post";
    cmntbtn.innerHTML = "Add";
    cmntbtn.setAttribute('class', 'addButton');



    likebtn.addEventListener("click", function () {
      firebase.database().ref("posts/" + id + '/likes').once("value", function (snapshot) {
        let data = snapshot.val();
        firebase.database().ref("posts/" + id + '/likes').set(data + 1);
      });
    });
    dislikebtn.addEventListener("click", function () {
      firebase.database().ref("posts/" + id + '/likes').once("value", function (snapshot) {
        let data = snapshot.val();
        firebase.database().ref("posts/" + id + '/likes').set(data - 1);
      });
    });
    deletebtn.addEventListener("click", function () {
      firebase.database().ref("posts/" + id).remove();
      firebase.database().ref("numPosts").once("value", function (snapshot) {
        let data = snapshot.val();
        firebase.database().ref("numPosts").set(--data);
        alert("Post has been deleted!");
        location.reload();
      });
    });
    div.setAttribute('class', 'card');
    likebtn.id = "button" + id;
    console.log(likebtn.id);

    div2.appendChild(likebtn);
    div2.appendChild(dislikebtn);
    div2.appendChild(deletebtn);
    div2.appendChild(br);
    div.appendChild(spanUser);
    div.appendChild(div2);
    div.appendChild(span);
    div.appendChild(br);
    div.appendChild(divDate);
    div3.appendChild(cmntbtn);
    divDate.appendChild(spanDate);
    div3.appendChild(comment);
    parentElement.appendChild(br);
    parentElement.appendChild(div3);
    parentElement.appendChild(div);

  }

  firebase.database().ref("posts").once("value", function (snapshot) {
    let data = snapshot.val();
    snapshot.forEach(function (post) {
      readPost(post.val().text, post.val().likes, post.val().id, post.val().date, post.val().email);
    });
  });
  firebase.database().ref("posts").on("value", function (snapshot) {
    let data = snapshot.val();
    snapshot.forEach(function (post) {
      displayPost(post.val().text, post.val().likes, post.val().id, post.val().date);
    });
  });

  $(".register form").on("submit", function (event) {
    event.preventDefault();

    var email = $(".register .email").val();
    var password = $(".register .password").val();

    //console.log(email);
    //console.log(password);
    firebase.auth().createUserWithEmailAndPassword(email, password)
      .then(function (user) {
        console.log(user);
      })
      .catch(function (err) {
        console.log(err);
      });
      //location.reload();
  });

  $(".login form").on("submit", function (event) {
    event.preventDefault();

    var email = $(".login .email").val();
    var password = $(".login .password").val();

    firebase.auth().signInWithEmailAndPassword(email, password)
      .then(function (user) {
        console.log(user);
      })
      .catch(function (err) {
        console.log(err);
      });
      //location.reload();
  });

  $(logoutBtn).on("click", function () {
    firebase.auth().signOut().then(function () {
      // Sign-out successful.
    }).catch(function (error) {
      // An error happened.
    });
  });

  firebase.auth().onAuthStateChanged(function (user) {

    $(postbutton).off();

    if (user) {
      console.log(user);
      var email = user.email;
      document.getElementById('welcomeMsg').innerHTML = "Welcome " + email + "!";
      $(postbutton).on("click", function () {
        createPost($('#createpost').val(), email);
      });
    } else {
      // No user is signed in.
      console.log("No user");
      document.getElementById('welcomeMsg').innerHTML = "Hello Guest! Log in to post and comment"
      $(postbutton).on("click", function () {
        alert("Please log in first!");
      });
    }
  });
</script>

</html>
